---
title: From Swiftmailer to Symfony Mailer
layout: post
permalink: /swift_to_symfony/
categories: ['DevOps', 'Drupal']
---

Drupal's Swiftmailer module is no longer supported as our site's Status Report keeps on reminding us and also that we must switch to Drupal's Symfony Mailer. So what to do?

Summary  
=======

We switched from Drupal's `mailsystem` and `swiftmailer` combination to Drupal's new Symfony Mailer on our Live and Dev servers whilst finding a simple solution to retaining our use use of `mailhog` on our dev system. 

Why is this important to us?  
============================

Our system  deploys several `simplenews` "issues" (distribution lists) in our role of supporting the functioning of our community. 

We send a low volume of emails but each one is important to us as many of our content types fulfil a statuary requirement.   

We don't use any third party mailing system like Mailchimp (although maybe we should at some point) but, for the time being, testing the functionality and appearance of our simplenews issues is important to us.

We were keen to switch our Simplenews and site emails from Mail System and Swiftmailer to Symfony Mailer with as little disruption as possible.

We use mailhog (and thus `mhsendmail`) to capture emails on our dev system running in a Parallels virtual machine provisioned using our fork of [Jeff Geering's Drupal-VM](https://www.drupalvm.com) which has mailhog provisioning built in.

History - and how we abandoned our approach
-------------------------------------------

On our dev system,  when provisioned, configured `php.ini` >> `sendmail_path=/opt/mailhog/mhsendmail` and on our our live system `sendmail_path` specified the default sendmail binary. In this way we could maintain an identical Drupal configuration between dev and live systems thus eliminating potential errors by minimising any configuration differences.

Well, that *was* our approach, but switching to Symfony Mailer whilst retaining our current php.ini settings and choosing SM’s Native Transport produced no errors yet neither did it produce any email output! We tried various combinations of -t -bs -i (mh)sendmail parameters with varying degrees of failure.

`mailhog` was working as mail sent from the Linux `mail` command  correctly invoked `mhsendmail` and messages are routed to the mailhog UI for inspection.

It is necessary to import previously-used `swiftmail` config settings into Symfony Mailer as a step in its [installation](https://www.drupal.org/docs/contributed-modules/symfony-mailer-0/getting-started#s-installation) process. We could verify that we had imported our swiftmailer configuration OK as, since mailhog uses port 1025, we can send our simplenews email messages to mailhog by using Symfony Mailer’s SMTP Transport specifying host 127.0.0.1 and port 1025.

But we could not meet our objective of having both dev and live Symfony Mail configuration use Native Transport. This is the approach we abandoned as it would seem that, in the nature of the `sendmail`-style interaction between the two processes (mailhog and symfony), each  has different expectations from the other.

Our solution
============

We *do* have a workable solution that allows us to trap emails in mailhog in dev and actually send messages via the `sendmail` transport on the live system both using Drupal Symfony Mailer and with the same config settings in both.

How we do it is this: the **default** Transport in the GUI is permanently set to `sendmail` but we also have a (non-default) SMTP Transport configuration set to Host 127.0.0.1 and Port 1025 (mailhog's port).  

So the `sendmail` configuration gets picked up in the Live system however  it gets  overriden by `smtp` in the dev system because we do a config override in our dev's `settings.php` thus:

```php
$config['symfony_mailer.settings']['default_transport'] = 'smtp';
```  

Theming 
=======

To be added shortly. 

We are talking about formatting the HTML messages generated by Simplenews when we send a node as a test message to one recipient or to all recipients of an issue / distribution list.  
We need to be able to capture the email message and see whether it has the correct HTML and is formatted correctly according to our CSS.

Changes to preprocessing function names  
---------------------------------------

First we need to enable TWIG Debugging in `services.yml`:  

```yaml
parameters:
  twig.config:
    debug: true 
```

Then, in outgoing emails, we will see the names of the TWIG templates that Drupal is looking for when it is rendering a node.  The suggested template names will appear in this manner (To be updated with real output) with an "x" against the one actually chosen. The "BEGIN OUTPUT" line will show whether the template was chosen from your own theme or one of its base themes for example

```
<!-- THEME DEBUG -->
<!-- THEME HOOK: 'node' -->
<!-- FILE NAME SUGGESTIONS:
   * node--view--frontpage--page-1.html.twig
   * node--view--frontpage.html.twig
   * node--1--teaser.html.twig
   * node--1.html.twig
   * node--article--teaser.html.twig
   * node--article.html.twig
   * node--teaser.html.twig
   x node.html.twig
-->
<!-- BEGIN OUTPUT from 'core/themes/classy/templates/content/node.html.twig' -->

<article data-history-node-id="1" data-quickedit-entity-id="node/1" role="article" class="contextual-region node node--type-article node--promoted node--view-mode-teaser" about="/node/1" typeof="schema:Article" data-quickedit-entity-instance-id="0">
....
</article>

<!-- END OUTPUT from 'core/themes/classy/templates/content/node.html.twig' -->
``` 

What we will notice is that Symfony Mailer has its own template naming conventions, so we will need to rename the templates that we used with Swiftmail. For example, after switching to Symfony Mailer our site has templates named like this:  

*   `node--article--email-html.html.twig` which is for a `article` content type node being displayed in its `email-html` view

At this point it will be necessary to rename the preprocess functions (if any) in our theme file. In our case we have our own contrib theme `pellucid_olivero` containing the following code correspondimg to the above template file:  

```php
function pellucid_olivero_preprocess_node__article__email_html(&$variables) {
  // https://api.drupal.org/api/drupal/core%21modules%21views%21views.module/function/views_embed_view/8.5.x
  $relatedArticles = views_embed_view('frontpage_news_items', 'block_2');
  $variables['related_articles'] = \Drupal::service('renderer'->render($relatedArticles);
}
```

And now we will probably need Xdebug to see exactly what data we are being passed in `$variables` so at this point I will refer those of you like me, are without  PHPStorm or a PHPStorm configured for Xdebugging,  to a previous post where I describe how to deploy [PHP 8.1's Xdebug 3 with Atom](https://iainhouston.com/atom_xdebug_client/).  

Changes to templates  
--------------------

For example, we have `email.html.twig` which takes the place of `swiftmail.html.twig` which we use to wrap the _body_ of our simplenews messages in a 600px wide table.  
(Please leave a comment if you have better ideas and know whether Microsoft email clients still need html tables to define a lowest common denominator of email client formatting, but we based this  I think from a helpful Mailchimp blog post):  

```html+jinja
<!DOCTYPE html>
<html lang="en" xmlns:o="urn:schemas-microsoft-com:office:office">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <!--[if mso]>
  <xml>
    <o:OfficeDocumentSettings>
      <o:PixelsPerInch>96</o:PixelsPerInch>
    </o:OfficeDocumentSettings>
  </xml>
  <![endif]-->
</head>
<body>
<!--[if mso]>
<table role="presentation" border="0" cellpadding="0" cellspacing="0" style="margin:0 auto; width:600px;"><tr><td>
<![endif]-->
<div class="body-wrapper">
  {{ body }}
</div>
<!--[if mso]>
</td></tr></table>
<![endif]-->
</body>
</html>
```

**to come**

The purpose and functionality of Symfony Mailer's *Policy* markup and how they simplify templates?

